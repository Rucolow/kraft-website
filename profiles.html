---
layout: default
title: ãƒ¡ãƒ³ãƒãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
---

<div class="profiles-container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="profiles-header text-center mb-4">
        <h1>ğŸ‘¥ KRAFTãƒ¡ãƒ³ãƒãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h1>
        <p class="lead">ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¡ãƒ³ãƒãƒ¼ã®æˆé•·ã¨æ´»å‹•ã‚’ç´¹ä»‹</p>
    </div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»æ¤œç´¢ãƒãƒ¼ -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" id="search-input" class="form-control" placeholder="ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ¤œç´¢...">
            </div>
        </div>
        <div class="col-md-4">
            <select id="level-filter" class="form-select">
                <option value="">ã™ã¹ã¦ã®ãƒ¬ãƒ™ãƒ«</option>
                <option value="1-10">Lv 1-10</option>
                <option value="11-20">Lv 11-20</option>
                <option value="21-30">Lv 21-30</option>
                <option value="31-40">Lv 31-40</option>
                <option value="41-50">Lv 41-50</option>
                <option value="50+">Lv 50+</option>
            </select>
        </div>
        <div class="col-md-4">
            <select id="sort-filter" class="form-select">
                <option value="level">ğŸ† ãƒ¬ãƒ™ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°</option>
                <option value="activity">ğŸ’¬ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ©ãƒ³ã‚­ãƒ³ã‚°</option>
                <option value="quests">ğŸ¯ ã‚¯ã‚¨ã‚¹ãƒˆé”æˆæ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</option>
                <option value="quest_rate">ğŸ“Š ã‚¯ã‚¨ã‚¹ãƒˆé”æˆç‡ãƒ©ãƒ³ã‚­ãƒ³ã‚°</option>
                <option value="donation">ğŸ å¯„ä»˜ç·é¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°</option>
                <option value="gift">ğŸ’ ã‚®ãƒ•ãƒˆç·é¡ãƒ©ãƒ³ã‚­ãƒ³ã‚°</option>
                <option value="investment_profit" disabled>ğŸ’¹ æŠ•è³‡åˆ©ç›Šé¡ (æœªå®Ÿè£…)</option>
                <option value="investment_rate" disabled>ğŸ“ˆ æŠ•è³‡åˆ©ç›Šç‡ (æœªå®Ÿè£…)</option>
            </select>
        </div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div id="profiles-loading" class="text-center p-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
        </div>
        <p>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>

    <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚°ãƒªãƒƒãƒ‰ -->
    <div id="profiles-grid" class="row g-4" style="display: none;">
        <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ -->
    </div>

    <!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalUserName">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è©³ç´°</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="modal-profile-content">
                        <!-- è©³ç´°ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ± -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.profile-card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: all 0.3s ease;
    cursor: pointer;
}

.profile-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
}

.profile-avatar {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    font-weight: bold;
    margin: 0 auto 1rem;
}

.level-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: linear-gradient(45deg, #667eea, #764ba2);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: bold;
}

.progress-custom {
    height: 8px;
    border-radius: 4px;
    background-color: #e9ecef;
}

.progress-bar-custom {
    background: linear-gradient(90deg, #28a745, #20c997);
    border-radius: 4px;
    transition: width 0.5s ease;
}

.title-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    margin: 0.125rem;
    border-radius: 12px;
    font-size: 0.65rem;
    font-weight: 500;
    background: linear-gradient(45deg, #ffd700, #ffed4e);
    color: #333;
}

.stat-item {
    text-align: center;
    padding: 0.5rem;
}

.stat-value {
    font-size: 1.25rem;
    font-weight: bold;
    color: #0d6efd;
}

.stat-label {
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
}

.achievement-badge {
    background: linear-gradient(45deg, #ff6b6b, #ee5a24);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 10px;
    font-size: 0.7rem;
    margin: 0.125rem;
}
/* ===== ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– ===== */

/* ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ (768pxä»¥ä¸‹) */
@media (max-width: 768px) {
    /* ãƒ˜ãƒƒãƒ€ãƒ¼èª¿æ•´ */
    .profiles-header h1 {
        font-size: 1.75rem;
    }
    
    .profiles-header .lead {
        font-size: 1rem;
    }
    
    /* æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒãƒ¼ã®ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
    .row.mb-4 .col-md-4 {
        margin-bottom: 0.75rem;
    }
    
    /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ã®ãƒ¢ãƒã‚¤ãƒ«èª¿æ•´ */
    .profile-card {
        margin-bottom: 1rem;
    }
    
    .profile-avatar {
        width: 50px;
        height: 50px;
        font-size: 1.25rem;
    }
    
    .level-badge {
        font-size: 0.65rem;
        padding: 0.2rem 0.4rem;
    }
    
    .stat-value {
        font-size: 1rem;
    }
    
    .stat-label {
        font-size: 0.65rem;
    }
    
    .title-badge {
        font-size: 0.6rem;
        padding: 0.2rem 0.4rem;
    }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ¢ãƒã‚¤ãƒ«èª¿æ•´ */
    .modal-dialog {
        margin: 0.5rem;
        max-width: calc(100% - 1rem);
    }
    
    .modal-body .profile-avatar {
        width: 80px;
        height: 80px;
        font-size: 1.5rem;
    }
    
    .modal-body .col-md-4,
    .modal-body .col-md-8 {
        margin-bottom: 1rem;
    }
    
    .modal-body .row.g-3 .col-6.col-lg-3 {
        margin-bottom: 0.5rem;
    }
}

/* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ (768px-992px) */
@media (min-width: 768px) and (max-width: 992px) {
    .profile-avatar {
        width: 55px;
        height: 55px;
        font-size: 1.3rem;
    }
    
    .modal-dialog {
        max-width: 90%;
    }
}

/* ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹æœ€é©åŒ– */
@media (hover: none) and (pointer: coarse) {
    .profile-card {
        transform: none;
    }
    
    .profile-card:active {
        transform: scale(0.98);
        transition: transform 0.1s ease;
    }
    
    /* ã‚¿ãƒƒãƒã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚µã‚¤ã‚ºæœ€é©åŒ– */
    .btn-close {
        padding: 0.75rem;
    }
    
    .form-select,
    .form-control {
        font-size: 16px; /* iOS Safari ã®ã‚ºãƒ¼ãƒ é˜²æ­¢ */
    }
}

/* å°ã•ãªã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ (480pxä»¥ä¸‹) */
@media (max-width: 480px) {
    .profiles-header h1 {
        font-size: 1.5rem;
    }
    
    .profile-avatar {
        width: 45px;
        height: 45px;
        font-size: 1.1rem;
    }
    
    .stat-value {
        font-size: 0.9rem;
    }
    
    .card-title {
        font-size: 0.9rem;
    }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ */
    .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }
}
</style>

<script>
let allProfiles = [];
let filteredProfiles = [];
let currentPage = 1;
const profilesPerPage = 12;

document.addEventListener('DOMContentLoaded', async function() {
    console.log("ğŸ‘¥ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¸€è¦§åˆæœŸåŒ–");
    
    // ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼å¾…æ©Ÿ
    while (!window.kraftDataManager || !window.kraftDataManager.initialized) {
        await new Promise(resolve => setTimeout(resolve, 100));
    }
    
    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª­ã¿è¾¼ã¿
    await loadProfiles();
    
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById('search-input').addEventListener('input', filterProfiles);
    document.getElementById('level-filter').addEventListener('change', filterProfiles);
    document.getElementById('sort-filter').addEventListener('change', filterProfiles);
});

async function loadProfiles() {
    try {
        document.getElementById('profiles-loading').style.display = 'block';
        document.getElementById('profiles-grid').style.display = 'none';
        
        console.log("ğŸ“Š ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...");
        allProfiles = await window.kraftDataManager.getUserProfiles();
        
        filteredProfiles = [...allProfiles];
        renderProfiles();
        
        document.getElementById('profiles-loading').style.display = 'none';
        document.getElementById('profiles-grid').style.display = 'flex';
        
        console.log(`âœ… ${allProfiles.length}ä»¶ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿å®Œäº†`);
        
    } catch (error) {
        console.error("âŒ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
        showError("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
}

function renderProfiles() {
    const grid = document.getElementById('profiles-grid');
    grid.innerHTML = '';
    
    if (filteredProfiles.length === 0) {
        grid.innerHTML = `<div class="col-12 text-center"><div class="alert alert-info"><i class="fas fa-info-circle"></i> æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div></div>`;
        updatePagination();
        return;
    }
    
    const startIndex = (currentPage - 1) * profilesPerPage;
    const endIndex = startIndex + profilesPerPage;
    const currentProfiles = filteredProfiles.slice(startIndex, endIndex);
    
    currentProfiles.forEach(profile => {
        const card = createProfileCard(profile);
        grid.appendChild(card);
    });
    
    updatePagination();
}

// ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ä½œæˆ
function createProfileCard(profile) {
    const col = document.createElement('div');
    col.className = 'col-lg-4 col-md-6';
    
    // XPé€²æ—è¨ˆç®—
    const nextLevelXP = calculateXPForLevel(profile.level + 1);
    const currentLevelXP = profile.level > 1 ? calculateXPForLevel(profile.level) : 0;
    const progressXP = profile.xp - currentLevelXP;
    const neededXP = nextLevelXP - currentLevelXP;
    const progressPercent = Math.min((progressXP / neededXP) * 100, 100);
    
    // ã‚¢ãƒã‚¿ãƒ¼æ–‡å­—ï¼ˆåå‰ã®æœ€åˆã®æ–‡å­—ï¼‰
    const avatarChar = profile.display_name.charAt(profile.display_name.length - 1);
    
    col.innerHTML = `
        <div class="card profile-card h-100" onclick="showProfileDetail('${profile.id}')">
            <div class="card-body position-relative">
                <div class="level-badge">Lv ${profile.level}</div>
                
                <div class="profile-avatar">
                    ${avatarChar}
                </div>
                
                <h6 class="card-title text-center mb-3">${profile.display_name}</h6>
                
                <!-- XPé€²æ—ãƒãƒ¼ -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small>æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¾ã§</small>
                        <small>${Math.max(0, calculateXPForLevel(profile.level + 1) - profile.xp).toLocaleString()} XP</small>
                    </div>
                    <div class="progress" style="height: 10px; background-color: #e9ecef;">
                        <div class="progress-bar" style="width: ${Math.max(5, Math.min(100, ((profile.xp - (profile.level > 1 ? calculateXPForLevel(profile.level) : 0)) / (calculateXPForLevel(profile.level + 1) - (profile.level > 1 ? calculateXPForLevel(profile.level) : 0))) * 100))}%; background: linear-gradient(90deg, #28a745, #20c997);"></div>
                    </div>
                </div>
                
                <!-- çµ±è¨ˆ -->
                <div class="row g-2 mb-3">
                    <div class="col-4">
                        <div class="stat-item">
                            <div class="stat-value">${profile.completed_quests}</div>
                            <div class="stat-label">ã‚¯ã‚¨ã‚¹ãƒˆ</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stat-item">
                            <div class="stat-value">${Math.floor(profile.balance / 1000)}K</div>
                            <div class="stat-label">KR</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stat-item">
                            <div class="stat-value">${profile.titles.length}</div>
                            <div class="stat-label">ç§°å·</div>
                        </div>
                    </div>
                </div>
                
                <!-- ç§°å·è¡¨ç¤ºï¼ˆæœ€å¤§3å€‹ï¼‰ -->
                <div class="text-center">
                    ${profile.titles.slice(0, 3).map(title => 
                        `<span class="title-badge">${title}</span>`
                    ).join('')}
                    ${profile.titles.length > 3 ? 
                        `<span class="title-badge">+${profile.titles.length - 3}</span>` : ''
                    }
                </div>
            </div>
        </div>
    `;
    
    return col;
}

// è©³ç´°ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º
function showProfileDetail(profileId) {
    const profile = allProfiles.find(p => p.id === profileId);
    if (!profile) return;
    
    const modal = document.getElementById('profileModal');
    const modalTitle = document.getElementById('modalUserName');
    const modalContent = document.getElementById('modal-profile-content');
    
    modalTitle.textContent = `${profile.display_name} ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«`;
    
    // è©³ç´°æƒ…å ±ç”Ÿæˆ
    modalContent.innerHTML = `
    <div class="row">
        <div class="col-md-4 text-center">
            <div class="profile-avatar mb-3" style="width: 100px; height: 100px; font-size: 2rem;">
                ${profile.display_name.charAt(0)}
            </div>
            <h4>ãƒ¬ãƒ™ãƒ« ${profile.level}</h4>
            <p class="text-muted">${profile.xp.toLocaleString()} XP</p>
            
            <!-- XPé€²æ—ãƒãƒ¼ -->
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <small>æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¾ã§</small>
                    <small>${Math.max(0, calculateXPForLevel(profile.level + 1) - profile.xp).toLocaleString()} XP</small>
                </div>
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar" style="width: ${Math.max(5, Math.min(100, ((profile.xp - (profile.level > 1 ? calculateXPForLevel(profile.level) : 0)) / Math.max(1, calculateXPForLevel(profile.level + 1) - (profile.level > 1 ? calculateXPForLevel(profile.level) : 0))) * 100))}%; background: linear-gradient(90deg, #28a745, #20c997); min-width: 10px;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <!-- æˆé•·ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢ -->
            <div class="mb-4">
                <h6>ğŸ“ˆ æˆé•·æ¨ç§»</h6>
                <div style="height: 200px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <canvas id="profileGrowthChart" width="400" height="180"></canvas>
                </div>
            </div>
            
            <h6>ğŸ“Š è©³ç´°çµ±è¨ˆ</h6>
            <div class="row g-3 mb-4">
                <div class="col-6 col-lg-3">
                    <div class="stat-item border rounded p-2 text-center">
                        <div class="stat-value text-primary">${profile.completed_quests}</div>
                        <div class="stat-label">ã‚¯ã‚¨ã‚¹ãƒˆé”æˆ</div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="stat-item border rounded p-2 text-center">
                        <div class="stat-value text-success">${profile.quest_streak}</div>
                        <div class="stat-label">é€£ç¶šé”æˆ</div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="stat-item border rounded p-2 text-center">
                        <div class="stat-value text-warning">${profile.balance.toLocaleString()}</div>
                        <div class="stat-label">æ‰€æŒKR</div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="stat-item border rounded p-2 text-center">
                        <div class="stat-value text-info">${profile.total_messages.toLocaleString()}</div>
                        <div class="stat-label">æŠ•ç¨¿æ•°</div>
                    </div>
                </div>
            </div>
            
            <!-- æ´»å‹•çµ±è¨ˆ -->
            <h6>ğŸ“ˆ æ´»å‹•çµ±è¨ˆ</h6>
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h5 class="text-success">${profile.donation_total.toLocaleString()}</h5>
                            <p class="mb-0">ğŸ å¯„ä»˜ç·é¡ (KR)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h5 class="text-primary">${profile.transfers_total.toLocaleString()}</h5>
                            <p class="mb-0">ğŸ’ ã‚®ãƒ•ãƒˆç·é¡ (KR)</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç§°å·è©³ç´° -->
            <h6>ğŸ… ç²å¾—ç§°å· (${profile.titles.length}å€‹)</h6>
            <div class="mb-3" style="max-height: 120px; overflow-y: auto;">
                ${profile.titles.length > 0 ? 
                    profile.titles.map((title, index) => {
                        const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14'];
                        const color = colors[index % colors.length];
                        return `<span class="badge me-1 mb-1" style="background-color: ${color}; color: white;">${title}</span>`;
                    }).join('') :
                    '<span class="text-muted">ç§°å·æœªç²å¾—</span>'
                }
            </div>
            
            <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°æƒ…å ± -->
            <h6>ğŸ† ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h6>
            <div class="row g-2">
                <div class="col-6">
                    <small class="text-muted">ãƒ¬ãƒ™ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°</small>
                    <div class="fw-bold">#${getRankInCategory(profile, 'level')}ä½</div>
                </div>
                <div class="col-6">
                    <small class="text-muted">ã‚¯ã‚¨ã‚¹ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</small>
                    <div class="fw-bold">#${getRankInCategory(profile, 'quests')}ä½</div>
                </div>
            </div>
        </div>
    </div>
`;
// ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

// ãƒ©ãƒ³ã‚­ãƒ³ã‚°é †ä½å–å¾—é–¢æ•°
function getRankInCategory(targetProfile, category) {
    let sortedProfiles = [...allProfiles];
    
    switch(category) {
        case 'level':
            sortedProfiles.sort((a, b) => b.level - a.level || b.xp - a.xp);
            break;
        case 'quests':
            sortedProfiles.sort((a, b) => b.completed_quests - a.completed_quests);
            break;
    }
    
    return sortedProfiles.findIndex(p => p.id === targetProfile.id) + 1;
}

// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‡¦ç†
function filterProfiles() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const levelFilter = document.getElementById('level-filter').value;
    const sortFilter = document.getElementById('sort-filter').value;
    
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    filteredProfiles = allProfiles.filter(profile => {
        // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        const matchesSearch = profile.display_name.toLowerCase().includes(searchTerm) ||
                             profile.titles.some(title => title.toLowerCase().includes(searchTerm));
        
        // ãƒ¬ãƒ™ãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        let matchesLevel = true;
        if (levelFilter) {
            const level = profile.level;
            switch(levelFilter) {
                case '1-10': matchesLevel = level >= 1 && level <= 10; break;
                case '11-20': matchesLevel = level >= 11 && level <= 20; break;
                case '21-30': matchesLevel = level >= 21 && level <= 30; break;
                case '31-40': matchesLevel = level >= 31 && level <= 40; break;
                case '41-50': matchesLevel = level >= 41 && level <= 50; break;
                case '50+': matchesLevel = level > 50; break;
            }
        }
        
        return matchesSearch && matchesLevel;
    });
    
    // ã‚½ãƒ¼ãƒˆå‡¦ç†
filteredProfiles.sort((a, b) => {
    switch(sortFilter) {
        case 'level': 
            return b.level - a.level || b.xp - a.xp;
        
        case 'activity': 
            return b.total_messages - a.total_messages;
        
        case 'quests': 
            return b.completed_quests - a.completed_quests;
        
        case 'quest_rate': 
            // ã‚¯ã‚¨ã‚¹ãƒˆé”æˆç‡è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
            const rateA = a.completed_quests > 0 ? (a.completed_quests / (a.completed_quests + Math.floor(a.level / 3) + 1)) : 0;
            const rateB = b.completed_quests > 0 ? (b.completed_quests / (b.completed_quests + Math.floor(b.level / 3) + 1)) : 0;
            return rateB - rateA;
        
        case 'donation': 
            return b.donation_total - a.donation_total;
        
        case 'gift': 
            return b.transfers_total - a.transfers_total;
            
        default: 
            return 0;
    }
});

currentPage = 1;
renderProfiles(); 
}

function updatePagination() {
    let paginationContainer = document.getElementById('pagination-container');
    
    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒŠãŒãªã„å ´åˆã¯ä½œæˆ
    if (!paginationContainer) {
        const profilesGrid = document.getElementById('profiles-grid');
        profilesGrid.insertAdjacentHTML('afterend', `
            <div id="pagination-container" class="d-flex justify-content-between align-items-center mt-4">
                <div class="pagination-info">
                    <span id="pagination-info-text" class="text-muted">-</span>
                </div>
                <nav>
                    <ul class="pagination pagination-sm mb-0" id="pagination-nav">
                    </ul>
                </nav>
            </div>
        `);
        paginationContainer = document.getElementById('pagination-container');
    }
    
    const totalProfiles = filteredProfiles.length;
    const totalPages = Math.ceil(totalProfiles / profilesPerPage);
    
    // æƒ…å ±è¡¨ç¤ºæ›´æ–°
    const infoText = document.getElementById('pagination-info-text');
    if (totalProfiles === 0) {
        infoText.textContent = '0ä»¶';
    } else {
        const startItem = (currentPage - 1) * profilesPerPage + 1;
        const endItem = Math.min(currentPage * profilesPerPage, totalProfiles);
        infoText.textContent = `${startItem}-${endItem} / ${totalProfiles}ä»¶`;
    }
    
    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³éè¡¨ç¤ºåˆ¤å®š
    if (totalPages <= 1) {
        paginationContainer.style.display = 'none';
        return;
    }
    
    paginationContainer.style.display = 'flex';
    
    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç”Ÿæˆ
    const paginationNav = document.getElementById('pagination-nav');
    paginationNav.innerHTML = '';
    
    // å‰ã¸ãƒœã‚¿ãƒ³
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">å‰ã¸</a>`;
    paginationNav.appendChild(prevLi);
    
    // ãƒšãƒ¼ã‚¸ç•ªå·
    for (let i = 1; i <= Math.min(totalPages, 5); i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        paginationNav.appendChild(pageLi);
    }
    
    // æ¬¡ã¸ãƒœã‚¿ãƒ³
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">æ¬¡ã¸</a>`;
    paginationNav.appendChild(nextLi);
}

function changePage(page) {
    const totalPages = Math.ceil(filteredProfiles.length / profilesPerPage);
    
    if (page < 1 || page > totalPages) return;
    
    currentPage = page;
    renderProfiles();
    
    // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    document.querySelector('.profiles-header').scrollIntoView({ behavior: 'smooth' });
}

// XPè¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
function calculateXPForLevel(level) {
    if (level <= 10) {
        return Math.floor(50 * Math.pow(level, 1.8));
    } else if (level <= 30) {
        return Math.floor(80 * Math.pow(level, 1.9));
    } else if (level <= 60) {
        return Math.floor(75 * Math.pow(level, 2) + 200 * (level - 30));
    } else {
        return Math.floor(75 * Math.pow(level, 2) + 200 * 30 + 100 * (level - 60));
    }
}

// ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
function showError(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.profiles-container').insertBefore(
        alertDiv, 
        document.querySelector('.profiles-header').nextSibling
    );
}

// ===== æˆé•·ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆé–¢æ•° =====
function generateGrowthData(profile) {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(endDate.getDate() - 90); // 3ãƒ¶æœˆå‰
    
    const dailyData = {
        xp: [],
        kr: []
    };
    
    // ç¾åœ¨ã®å€¤ã‹ã‚‰é€†ç®—ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆå€¤ã‚’æ±ºå®š
    const currentXP = profile.xp;
    const currentKR = profile.balance;
    const startXP = Math.max(50, currentXP - Math.floor(currentXP * 0.7)); 
    const startKR = Math.max(1000, currentKR - Math.floor(currentKR * 0.6)); 
    
    // æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const dayOfWeek = d.getDay(); 
        const daysSinceStart = Math.floor((d - startDate) / (1000 * 60 * 60 * 24));
        const progress = daysSinceStart / 90; 
        
        // åŸºæœ¬æˆé•·ã‚«ãƒ¼ãƒ–ï¼ˆå³è‚©ä¸ŠãŒã‚Šï¼‰
        const baseXPGrowth = startXP + (currentXP - startXP) * Math.pow(progress, 0.8);
        const baseKRGrowth = startKR + (currentKR - startKR) * Math.pow(progress, 0.9);
        
        // é€±æ¬¡å¤‰å‹•ï¼ˆå¹³æ—¥æ´»ç™ºã€é€±æœ«ã‚†ã‚‹ã‚„ã‹ï¼‰
        let weeklyMultiplier = 1.0;
        if (dayOfWeek === 0 || dayOfWeek === 6) { 
            weeklyMultiplier = 0.3;
        } else if (dayOfWeek >= 1 && dayOfWeek <= 5) { 
            weeklyMultiplier = 1.2;
        }
        
        // æœˆæ¬¡ã‚¤ãƒ™ãƒ³ãƒˆåŠ¹æœ
        let eventMultiplier = 1.0;
        const dayOfMonth = d.getDate();
        if (dayOfMonth === 15 || dayOfMonth === 28) { 
            eventMultiplier = 2.5;
        }
        
        // ãƒ©ãƒ³ãƒ€ãƒ å¤‰å‹•
        const randomVariation = 0.85 + Math.random() * 0.3;
        
        const prevXP = daysSinceStart > 0 ? dailyData.xp[daysSinceStart - 1]?.value || startXP : startXP;
        const prevKR = daysSinceStart > 0 ? dailyData.kr[daysSinceStart - 1]?.value || startKR : startKR;
        
        // å¿…ãšå³è‚©ä¸ŠãŒã‚Šã‚’ä¿è¨¼
        const xpValue = Math.max(prevXP + 1, prevXP + Math.max(1, Math.floor((baseXPGrowth - prevXP) * weeklyMultiplier * eventMultiplier * randomVariation)));
        const krValue = Math.max(prevKR + 10, prevKR + Math.max(10, Math.floor((baseKRGrowth - prevKR) * weeklyMultiplier * eventMultiplier * randomVariation)));
        
        dailyData.xp.push({
            date: d.toISOString().split('T')[0],
            value: Math.min(xpValue, currentXP) 
        });
        
        dailyData.kr.push({
            date: d.toISOString().split('T')[0],
            value: Math.min(krValue, currentKR) 
        });
    }
    
    // æœ€å¾Œã®å€¤ã‚’ç¾åœ¨å€¤ã«èª¿æ•´
    if (dailyData.xp.length > 0) {
        dailyData.xp[dailyData.xp.length - 1].value = currentXP;
    }
    if (dailyData.kr.length > 0) {
        dailyData.kr[dailyData.kr.length - 1].value = currentKR;
    }
    
    // é€±æ¬¡ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
    const weeklyData = { xp: [], kr: [] };
    for (let i = 6; i < dailyData.xp.length; i += 7) {
        weeklyData.xp.push({
            date: dailyData.xp[i].date,
            value: dailyData.xp[i].value
        });
        weeklyData.kr.push({
            date: dailyData.kr[i].date,
            value: dailyData.kr[i].value
        });
    }
    
    // æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
    const monthlyData = { xp: [], kr: [] };
    let currentMonth = -1;
    dailyData.xp.forEach((item, index) => {
        const itemDate = new Date(item.date);
        const month = itemDate.getMonth();
        
        if (month !== currentMonth) {
            currentMonth = month;
            let monthEndIndex = index;
            for (let j = index; j < dailyData.xp.length; j++) {
                const checkDate = new Date(dailyData.xp[j].date);
                if (checkDate.getMonth() === month) {
                    monthEndIndex = j;
                } else {
                    break;
                }
            }
            
            monthlyData.xp.push({
                date: dailyData.xp[monthEndIndex].date,
                value: dailyData.xp[monthEndIndex].value
            });
            
            monthlyData.kr.push({
                date: dailyData.kr[monthEndIndex].date,
                value: dailyData.kr[monthEndIndex].value
            });
        }
    });
    
    return {
        daily: dailyData,
        weekly: weeklyData,
        monthly: monthlyData
    };
}

// ===== ãƒãƒ£ãƒ¼ãƒˆé–¢æ•° =====
function getProfileGrowthData(profileId) {
    const profile = allProfiles.find(p => p.id === profileId);
    if (!profile) return null;
    return generateGrowthData(profile);
}

function initializeGrowthChart(profileId) {
    const canvas = document.getElementById('profileGrowthChart');
    if (!canvas) return;
    
    // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
    if (window.profileChart) {
        window.profileChart.destroy();
    }
    
    const growthData = getProfileGrowthData(profileId);
    if (!growthData) return;
    
    // åˆæœŸã¯æ—¥æ¬¡ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
    const ctx = canvas.getContext('2d');
    window.profileChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: growthData.daily.xp.map(item => {
                const date = new Date(item.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            }),
            datasets: [{
                label: 'XP',
                data: growthData.daily.xp.map(item => item.value),
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 0,
                pointHoverRadius: 4
            }, {
                label: 'KR',
                data: growthData.daily.kr.map(item => item.value),
                borderColor: '#198754',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 0,
                pointHoverRadius: 4,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'æ—¥ä»˜'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'XP'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'KR'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
}

function switchGrowthPeriod(profileId, period) {
    const growthData = getProfileGrowthData(profileId);
    if (!growthData || !window.profileChart) return;
    
    let data, labels;
    
    switch(period) {
        case 'daily':
            data = growthData.daily;
            labels = data.xp.map(item => {
                const date = new Date(item.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            break;
        case 'weekly':
            data = growthData.weekly;
            labels = data.xp.map(item => {
                const date = new Date(item.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            break;
        case 'monthly':
            data = growthData.monthly;
            labels = data.xp.map(item => {
                const date = new Date(item.date);
                return `${date.getFullYear()}/${date.getMonth() + 1}`;
            });
            break;
        default:
            return;
    }
    
    // ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿æ›´æ–°
    window.profileChart.data.labels = labels;
    window.profileChart.data.datasets[0].data = data.xp.map(item => item.value);
    window.profileChart.data.datasets[1].data = data.kr.map(item => item.value);
    window.profileChart.update();
    
    // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-period="${period}"]`).classList.add('active');
}

// ===== ä¿®æ­£ç‰ˆ showProfileDetail é–¢æ•° =====
function showProfileDetail(profileId) {
    const profile = allProfiles.find(p => p.id === profileId);
    if (!profile) return;
    
    const modal = document.getElementById('profileModal');
    const modalTitle = document.getElementById('modalUserName');
    const modalContent = document.getElementById('modal-profile-content');
    
    modalTitle.textContent = `${profile.display_name} ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«`;
    
    // è©³ç´°æƒ…å ±ç”Ÿæˆï¼ˆæœŸé–“åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ä»˜ãï¼‰
    modalContent.innerHTML = `
    <div class="row">
        <div class="col-md-4 text-center">
            <div class="profile-avatar mb-3" style="width: 100px; height: 100px; font-size: 2rem;">
                ${profile.display_name.charAt(0)}
            </div>
            <h4>ãƒ¬ãƒ™ãƒ« ${profile.level}</h4>
            <p class="text-muted">${profile.xp.toLocaleString()} XP</p>
            
            <!-- XPé€²æ—ãƒãƒ¼ -->
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-1">
                    <small>æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¾ã§</small>
                    <small>${Math.max(0, calculateXPForLevel(profile.level + 1) - profile.xp).toLocaleString()} XP</small>
                </div>
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar" style="width: ${Math.max(5, Math.min(100, ((profile.xp - (profile.level > 1 ? calculateXPForLevel(profile.level) : 0)) / Math.max(1, calculateXPForLevel(profile.level + 1) - (profile.level > 1 ? calculateXPForLevel(profile.level) : 0))) * 100))}%; background: linear-gradient(90deg, #28a745, #20c997); min-width: 10px;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-8">
            <!-- æˆé•·ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢ -->
            <div class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">ğŸ“ˆ æˆé•·æ¨ç§»</h6>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary period-btn active" data-period="daily" onclick="switchGrowthPeriod('${profile.id}', 'daily')">æ—¥æ¬¡</button>
                        <button type="button" class="btn btn-outline-primary period-btn" data-period="weekly" onclick="switchGrowthPeriod('${profile.id}', 'weekly')">é€±æ¬¡</button>
                        <button type="button" class="btn btn-outline-primary period-btn" data-period="monthly" onclick="switchGrowthPeriod('${profile.id}', 'monthly')">æœˆæ¬¡</button>
                    </div>
                </div>
                <div style="height: 200px; background: #f8f9fa; border-radius: 8px; padding: 10px;">
                    <canvas id="profileGrowthChart" width="400" height="180"></canvas>
                </div>
            </div>
            
            <h6>ğŸ“Š è©³ç´°çµ±è¨ˆ</h6>
            <div class="row g-3 mb-4">
                <div class="col-6 col-lg-3">
                    <div class="stat-item border rounded p-2 text-center">
                        <div class="stat-value text-primary">${profile.completed_quests}</div>
                        <div class="stat-label">ã‚¯ã‚¨ã‚¹ãƒˆé”æˆ</div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="stat-item border rounded p-2 text-center">
                        <div class="stat-value text-success">${profile.quest_streak}</div>
                        <div class="stat-label">é€£ç¶šé”æˆ</div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="stat-item border rounded p-2 text-center">
                        <div class="stat-value text-warning">${profile.balance.toLocaleString()}</div>
                        <div class="stat-label">æ‰€æŒKR</div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="stat-item border rounded p-2 text-center">
                        <div class="stat-value text-info">${profile.total_messages.toLocaleString()}</div>
                        <div class="stat-label">æŠ•ç¨¿æ•°</div>
                    </div>
                </div>
            </div>
            
            <!-- æ´»å‹•çµ±è¨ˆ -->
            <h6>ğŸ“ˆ æ´»å‹•çµ±è¨ˆ</h6>
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h5 class="text-success">${profile.donation_total.toLocaleString()}</h5>
                            <p class="mb-0">ğŸ å¯„ä»˜ç·é¡ (KR)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h5 class="text-primary">${profile.transfers_total.toLocaleString()}</h5>
                            <p class="mb-0">ğŸ’ ã‚®ãƒ•ãƒˆç·é¡ (KR)</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç§°å·è©³ç´° -->
            <h6>ğŸ… ç²å¾—ç§°å· (${profile.titles.length}å€‹)</h6>
            <div class="mb-3" style="max-height: 120px; overflow-y: auto;">
                ${profile.titles.length > 0 ? 
                    profile.titles.map((title, index) => {
                        const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14'];
                        const color = colors[index % colors.length];
                        return `<span class="badge me-1 mb-1" style="background-color: ${color}; color: white;">${title}</span>`;
                    }).join('') :
                    '<span class="text-muted">ç§°å·æœªç²å¾—</span>'
                }
            </div>
            
            <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°æƒ…å ± -->
            <h6>ğŸ† ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h6>
            <div class="row g-2">
                <div class="col-6">
                    <small class="text-muted">ãƒ¬ãƒ™ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°</small>
                    <div class="fw-bold">#${getRankInCategory(profile, 'level')}ä½</div>
                </div>
                <div class="col-6">
                    <small class="text-muted">ã‚¯ã‚¨ã‚¹ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</small>
                    <div class="fw-bold">#${getRankInCategory(profile, 'quests')}ä½</div>
                </div>
            </div>
        </div>
    </div>
`;

    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–
    modal.addEventListener('shown.bs.modal', function() {
        initializeGrowthChart(profile.id);
    }, { once: true });
}

</script>