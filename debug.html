---
layout: default
title: KRAFTè¨ºæ–­
---

<div class="container">
    <h1>ğŸ”§ KRAFT ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­</h1>
    <p class="lead">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿æ¥ç¶šçŠ¶æ³ã‚’ç¢ºèªã—ã¾ã™</p>
    
    <div class="row g-4">
        <!-- è¨ºæ–­ãƒœã‚¿ãƒ³ -->
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <h5>ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã‚’å®Ÿè¡Œ</h5>
                    <button id="run-diagnosis" class="btn btn-primary btn-lg">
                        ğŸ” è¨ºæ–­é–‹å§‹
                    </button>
                </div>
            </div>
        </div>
        
        <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ“Š è¨ºæ–­çµæœ</h5>
                </div>
                <div class="card-body">
                    <div id="diagnosis-results">
                        <p class="text-muted">è¨ºæ–­ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ãƒ‡ãƒ¼ã‚¿åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                        <button id="switch-real-data" class="btn btn-success">
                            ğŸ“¡ å®Ÿãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
                        </button>
                        <button id="switch-mock-data" class="btn btn-warning">
                            ğŸ­ ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
                        </button>
                        <button id="clear-cache" class="btn btn-info">
                            ğŸ—‘ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º -->
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>ğŸ‘¤ ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ«</h5>
                </div>
                <div class="card-body">
                    <div id="data-sample">
                        <p class="text-muted">è¨ºæ–­å®Ÿè¡Œå¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const diagnosisBtn = document.getElementById('run-diagnosis');
    const resultsDiv = document.getElementById('diagnosis-results');
    const sampleDiv = document.getElementById('data-sample');
    
    // è¨ºæ–­å®Ÿè¡Œ
    diagnosisBtn.addEventListener('click', async function() {
        resultsDiv.innerHTML = '<div class="spinner-border text-primary" role="status"></div> è¨ºæ–­ä¸­...';
        sampleDiv.innerHTML = '<div class="spinner-border text-secondary" role="status"></div> ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...';
        
        try {
            await runCompleteDiagnosis();
        } catch (error) {
            resultsDiv.innerHTML = `<div class="alert alert-danger">è¨ºæ–­ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
        }
    });
    
    // å®Ÿãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
    document.getElementById('switch-real-data').addEventListener('click', function() {
        window.FIREBASE_MOCK_MODE = false;
        window.FIREBASE_CONNECTION_ERROR = false;
        alert('å®Ÿãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        window.location.reload();
    });
    
    // ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
    document.getElementById('switch-mock-data').addEventListener('click', function() {
        window.FIREBASE_MOCK_MODE = true;
        alert('ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        window.location.reload();
    });
    
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
    document.getElementById('clear-cache').addEventListener('click', function() {
        if (window.kraftDataManager) {
            window.kraftDataManager.clearCache();
            alert('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');
        }
    });
});

async function runCompleteDiagnosis() {
    const results = [];
    
    // 1. ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
    results.push('<h6>ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h6>');
    
    const status = window.kraftDataManager ? window.kraftDataManager.getConnectionStatus() : null;
    if (status) {
        results.push(`<ul>`);
        results.push(`<li>åˆæœŸåŒ–çŠ¶æ…‹: <span class="badge bg-${status.initialized ? 'success' : 'danger'}">${status.initialized ? 'æˆåŠŸ' : 'å¤±æ•—'}</span></li>`);
        results.push(`<li>ãƒ¢ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰: <span class="badge bg-${status.mock_mode ? 'warning' : 'success'}">${status.mock_mode ? 'ON' : 'OFF'}</span></li>`);
        results.push(`<li>æ¥ç¶šã‚¨ãƒ©ãƒ¼: <span class="badge bg-${status.connection_error ? 'danger' : 'success'}">${status.connection_error ? 'ã‚ã‚Š' : 'ãªã—'}</span></li>`);
        results.push(`<li>Firebaseåˆ©ç”¨å¯èƒ½: <span class="badge bg-${status.firebase_available ? 'success' : 'danger'}">${status.firebase_available ? 'ã¯ã„' : 'ã„ã„ãˆ'}</span></li>`);
        results.push(`<li>Firestoreåˆ©ç”¨å¯èƒ½: <span class="badge bg-${status.firestore_available ? 'success' : 'danger'}">${status.firestore_available ? 'ã¯ã„' : 'ã„ã„ãˆ'}</span></li>`);
        results.push(`<li>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¨ãƒ³ãƒˆãƒªæ•°: ${status.cache_entries}</li>`);
        results.push(`</ul>`);
    } else {
        results.push('<div class="alert alert-danger">ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>');
    }
    
    // 2. Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆ
    results.push('<h6>ğŸ”¥ Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆ</h6>');
    
    if (window.db) {
        try {
            const snapshot = await window.db.collection('users').limit(3).get();
            results.push(`<div class="alert alert-success">âœ… Firestoreæ¥ç¶šæˆåŠŸ: ${snapshot.size}ä»¶ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ç¢ºèª</div>`);
            
            // ãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ«è¡¨ç¤º
            const samples = [];
            snapshot.forEach((doc, index) => {
                // Firebase v9å¯¾å¿œ
                const data = doc.data ? doc.data() : doc.to_dict();
                samples.push(`
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6>ãƒ¦ãƒ¼ã‚¶ãƒ¼${index + 1} (ID: ${doc.id.slice(-4)})</h6>
                            <ul class="mb-0">
                                <li>ãƒ¬ãƒ™ãƒ«: ${data.level || 'ãªã—'}</li>
                                <li>çµŒé¨“å€¤: ${data.xp || 'ãªã—'}</li>
                                <li>æ®‹é«˜: ${data.balance || 'ãªã—'} KR</li>
                                <li>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: ${data.total_messages || 'ãªã—'}</li>
                                <li>ã‚¯ã‚¨ã‚¹ãƒˆé”æˆ: ${data.completed_quests || 'ãªã—'}</li>
                                <li>ç§°å·: ${data.titles ? data.titles.join(', ') : 'ãªã—'}</li>
                            </ul>
                        </div>
                    </div>
                `);
            });
            
            document.getElementById('data-sample').innerHTML = samples.join('');
            
        } catch (error) {
            results.push(`<div class="alert alert-danger">âŒ Firestoreæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}</div>`);
            
            if (error.message.includes('permission-denied')) {
                results.push(`
                    <div class="alert alert-info">
                        <strong>è§£æ±ºæ–¹æ³•:</strong><br>
                        Firebase Console â†’ Firestore â†’ Rules ã§èª­ã¿å–ã‚Šæ¨©é™ã‚’è¨±å¯ã—ã¦ãã ã•ã„
                    </div>
                `);
            }
        }
    } else {
        results.push('<div class="alert alert-warning">FirestoreãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>');
    }
    
    // 3. ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ
    results.push('<h6>ğŸ“Š ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ†ã‚¹ãƒˆ</h6>');
    
    try {
        const profiles = await window.kraftDataManager.getUserProfiles();
        results.push(`<div class="alert alert-success">âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—æˆåŠŸ: ${profiles.length}ä»¶</div>`);
        
        const stats = await window.kraftDataManager.getServerStats();
        results.push(`<div class="alert alert-success">âœ… ã‚µãƒ¼ãƒãƒ¼çµ±è¨ˆå–å¾—æˆåŠŸ: å¹³å‡ãƒ¬ãƒ™ãƒ« ${stats.average_level}</div>`);
        
        // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ç¢ºèª
        if (window.FIREBASE_MOCK_MODE || window.FIREBASE_CONNECTION_ERROR) {
            results.push('<div class="alert alert-warning">âš ï¸ ç¾åœ¨ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ä¸­</div>');
        } else {
            results.push('<div class="alert alert-success">âœ… å®Ÿãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ä¸­</div>');
        }
        
    } catch (error) {
        results.push(`<div class="alert alert-danger">âŒ ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`);
    }
    
    // 4. æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    results.push('<h6>ğŸ’¡ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h6>');
    
    if (status && status.mock_mode) {
        results.push(`
            <div class="alert alert-info">
                <strong>ç¾åœ¨ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚</strong><br>
                å®Ÿãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯ã€Œå®Ÿãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
            </div>
        `);
    } else if (status && !status.firestore_available) {
        results.push(`
            <div class="alert alert-warning">
                <strong>Firestoreæ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚</strong><br>
                Firebaseè¨­å®šã¨Rulesã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
            </div>
        `);
    } else {
        results.push(`
            <div class="alert alert-success">
                <strong>ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ï¼</strong><br>
                ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§å®Ÿãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã¯ãšã§ã™ã€‚
            </div>
        `);
    }
    
    document.getElementById('diagnosis-results').innerHTML = results.join('');
}
</script>

<style>
.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.spinner-border {
    width: 1.5rem;
    height: 1.5rem;
}
</style>